<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Collections System – Login</title>
<style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);font-family:Segoe UI,Arial,sans-serif}
    .card{background:#fff;padding:40px;border-radius:15px;box-shadow:0 15px 35px rgba(0,0,0,.1);width:100%;max-width:380px}
    h1{font-size:28px;color:#333;margin-bottom:6px;text-align:center}
    p.sub{font-size:14px;color:#666;text-align:center;margin-bottom:30px}
    .field{margin-bottom:20px}
    label{font-weight:600;color:#333;margin-bottom:8px;display:block}
    input{width:100%;padding:12px;border:2px solid #e1e1e1;border-radius:8px;font-size:15px;transition:border-color .3s}
    input:focus{outline:none;border-color:#667eea}
    button{width:100%;padding:12px;background:#667eea;color:#fff;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;transition:background .25s}
    button:hover{background:#5a6fd8}
    button:disabled{background:#ccc;cursor:not-allowed}
    .error{display:none;background:#fee2e2;color:#dc2626;padding:14px;border-radius:5px;font-size:14px;margin-top:15px}
    .loading{display:none;text-align:center;color:#667eea;margin-top:15px;font-size:14px}
    .success{display:none;background:#e8f5e8;color:#2e7d32;padding:14px;border-radius:5px;font-size:14px;margin-top:15px}
</style>
</head>
<body>
    <div class="card">
        <h1>Collections System</h1>
        <p class="sub">Login to access your dashboard</p>

        <form id="loginForm">
            <div class="field">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" autocomplete="username" required>
            </div>
            <div class="field">
                <label for="password">Password</label>
                <input id="password" name="password" type="password" autocomplete="current-password" required>
            </div>
            <button id="loginBtn" type="submit">Login</button>
            <div id="errorBox" class="error"></div>
            <div id="successBox" class="success"></div>
            <div id="loadingBox" class="loading">Authenticating…</div>
        </form>
    </div>

<script>
(() => {
    const form       = document.getElementById('loginForm');
    const btn        = document.getElementById('loginBtn');
    const errBox     = document.getElementById('errorBox');
    const successBox = document.getElementById('successBox');
    const loadBox    = document.getElementById('loadingBox');
    
    // CONFIGURATION
    const apiURL  = 'https://eram-intl.app.n8n.cloud/webhook/login';
    const baseURL = 'https://jacey-pixel.github.io/eram-collections-system/';

    const showError = msg => { 
        errBox.textContent = msg; 
        errBox.style.display = 'block';
        successBox.style.display = 'none';
    };

    const showSuccess = msg => { 
        successBox.textContent = msg; 
        successBox.style.display = 'block';
        errBox.style.display = 'none';
    };

    const hideMessages = () => { 
        errBox.style.display = 'none'; 
        successBox.style.display = 'none';
    };

    form.addEventListener('submit', async e => {
        e.preventDefault();
        hideMessages();

        const email    = form.email.value.trim().toLowerCase();
        const password = form.password.value.trim();

        btn.disabled = true;  
        loadBox.style.display = 'block';

        try {
            const res = await fetch(apiURL, {
                method : 'POST',
                headers: { 'Content-Type':'application/json' },
                body   : JSON.stringify({ email, password })
            });

            const data = await res.json();

            // Handle the case where n8n returns success: false
            if (!data.success || !data.userInfo) {
                throw new Error(data.message || 'Invalid email or password');
            }

            showSuccess('Login successful! Redirecting...');
            
            // ✅ PERSIST SESSION
            localStorage.setItem('sessionToken', data.userInfo.sessionToken);
            localStorage.setItem('userInfo', JSON.stringify(data.userInfo));

            // ✅ REDIRECTION LOGIC
            // If n8n sends a full URL, use it. Otherwise, construct it from baseURL.
            let finalUrl = data.redirectUrl;
            if (finalUrl && !finalUrl.startsWith('http')) {
                const target = finalUrl.startsWith('/') ? finalUrl.substring(1) : finalUrl;
                finalUrl = baseURL + target;
            } else if (!finalUrl) {
                // Fallback if n8n misses the URL
                finalUrl = (data.userInfo.type === 'SUPERVISOR') 
                    ? baseURL + 'supervisor-dashboard.html' 
                    : baseURL + 'dashboard.html';
            }

            setTimeout(() => {
                window.location.href = finalUrl;
            }, 1000);

        }
        catch (err) { 
            showError(err.message); 
        }
        finally { 
            btn.disabled = false; 
            loadBox.style.display = 'none'; 
        }
    });

    // ✅ SESSION RESUME LOGIC (Absolute Paths)
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('sessionToken');
        const user  = localStorage.getItem('userInfo');
        
        if (token && user) {
            const userInfo = JSON.parse(user);
            const target = userInfo.type === 'SUPERVISOR' 
                ? 'supervisor-dashboard.html' 
                : 'dashboard.html';
            
            showSuccess('Session found. Accessing dashboard...');
            setTimeout(() => {
                window.location.href = baseURL + target + '?v=' + Date.now();
            }, 1000);
        }
    });
})();
</script>
</body>
</html>


