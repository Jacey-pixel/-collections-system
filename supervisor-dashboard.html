<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Supervisor Dashboard ‚Äì Collections Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- ‚Äë-- Minimal styling for clear, responsive layout ‚Äë-- -->
    <style>
        :root {
            --primary: #004a99;
            --danger:  #d32f2f;
            --warning: #f57c00;
            --success: #2e7d32;
            --bg-light:#f8f9fa;
        }
        body       { margin: 0; font-family: Arial, sans-serif; background: var(--bg-light); }
        header     { background: var(--primary); color: #fff; padding: 1rem 1.5rem; }
        h1, h2     { margin: 0; }
        .wrapper   { padding: 1.5rem; max-width: 1400px; margin: auto; }
        .kpi-grid  { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; }
        .kpi-box   { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem; text-align: center; }
        .kpi-label { font-size: .85rem; color: #666; }
        .kpi-value { font-size: 1.6rem; font-weight: bold; margin-top: .25rem; }
        .tabs      { margin-top: 2rem; display: flex; gap: .5rem; }
        .tab-btn   { flex: 1; padding: .75rem; border: 1px solid var(--primary); background:#fff; cursor:pointer; text-align:center; }
        .tab-btn.active{ background: var(--primary); color:#fff; }
        .section   { margin-top: 1.5rem; background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:1rem; }
        table      { width:100%; border-collapse: collapse; margin-top:.75rem; }
        th,td      { border:1px solid #ddd; padding:.5rem .6rem; font-size:.85rem; }
        th         { background:#f2f2f2; }
        .alert-row.high    { background:#fff3e0; }
        .alert-row.critical{ background:#ffebee; }
        .badge      { display:inline-block; padding:.2rem .5rem; border-radius:4px; font-size:.75rem; }
        .bg-danger  { background:var(--danger);  color:#fff; }
        .bg-warning { background:var(--warning); color:#fff; }
        .bg-success { background:var(--success); color:#fff; }
        #loading    { text-align:center; padding:2rem; font-size:1.1rem; color:#666; }
        @media (max-width:600px){
            .kpi-value{font-size:1.3rem;}
        }
    </style>
</head>
<body>
    <header>
        <h1>Supervisor Dashboard</h1>
        <h2 style="font-size:1rem; font-weight: normal;">Real-time Collections Overview</h2>
    </header>

    <div class="wrapper">
        <!-- KPI CARDS -->
        <div id="kpiSection" class="kpi-grid" style="display:none;"></div>

        <!-- TABS -->
        <div class="tabs">
            <div id="alertsTab"     class="tab-btn active" onclick="switchTab('alerts')">System Alerts</div>
            <div id="collectorsTab" class="tab-btn"        onclick="switchTab('collectors')">Collector Performance</div>
        </div>

        <!-- ALERT SECTION -->
        <div id="alertsSection" class="section">
            <h3>üîî Active Alerts</h3>
            <table id="alertsTable">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Client</th>
                        <th>Outstanding (SAR)</th>
                        <th>Days Since Contact</th>
                        <th>Assigned Collector</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- COLLECTOR PERFORMANCE SECTION -->
        <div id="collectorsSection" class="section" style="display:none;">
            <h3>üë§ Collector Performance</h3>
            <table id="collectorsTable">
                <thead>
                    <tr>
                        <th>Collector</th>
                        <th>Clients</th>
                        <th>Portfolio (SAR)</th>
                        <th>Follow-ups Today</th>
                        <th>Payments Today</th>
                        <th>Logged-in</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="loading">Loading dashboard data‚Ä¶</div>
    </div>

    <script>
    /* ------------------------- CONFIG ------------------------- */
    const API_URL   = 'https://eram-intl.app.n8n.cloud/webhook/supervisor-data';
    const TOKEN_KEY = 'supervisorToken';
    /* ---------------------------------------------------------- */

    // Simple tab switcher
    function switchTab(target){
        document.getElementById('alertsTab').classList.toggle('active', target==='alerts');
        document.getElementById('collectorsTab').classList.toggle('active', target==='collectors');
        document.getElementById('alertsSection').style.display     = target==='alerts'     ? '' : 'none';
        document.getElementById('collectorsSection').style.display = target==='collectors' ? '' : 'none';
    }

    async function loadDashboard(){
        const token = localStorage.getItem(TOKEN_KEY);
        if(!token){
            alert('Session expired. Please log in again.');
            window.location.href = '/supervisor-login.html';
            return;
        }
        try{
            const res  = await fetch(`${API_URL}?token=${encodeURIComponent(token)}`,{
                headers:{ 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if(!data.success){ throw new Error(data.message || 'Failed'); }

            buildKPIs(data.system_kpis);
            buildAlerts(data.alerts);
            buildCollectorTable(data.collector_stats);

            document.getElementById('loading').style.display='none';
            document.getElementById('kpiSection').style.display='';
        }catch(err){
            console.error(err);
            document.getElementById('loading').innerText='Error loading data. Try refreshing.';
        }
    }

    /* ---------- Builders ---------- */
    function buildKPIs(kpis){
        const wrap=document.getElementById('kpiSection');
        wrap.innerHTML='';
        const entries=[
            {label:'Total Portfolio', val: kpis.total_portfolio.toLocaleString('en-US')+' SAR'},
            {label:'Collectors Online', val:kpis.collectors_online},
            {label:'Daily Collections', val:kpis.daily_collections.toLocaleString('en-US')+' SAR', cls:'bg-success'},
            {label:'High-Value Overdue', val:kpis.overdue_high_value, cls:'bg-danger'}
        ];
        entries.forEach(e=>{
            const box=document.createElement('div'); box.className='kpi-box';
            const span=document.createElement('div'); span.className='kpi-value';
            if(e.cls) span.classList.add(e.cls); span.textContent=e.val;
            box.innerHTML=`<div class="kpi-label">${e.label}</div>`; box.appendChild(span);
            wrap.appendChild(box);
        });
    }

    function buildAlerts(alerts){
        const body=document.querySelector('#alertsTable tbody');
        body.innerHTML='';
        if(!alerts.length){
            body.innerHTML='<tr><td colspan="5" style="text-align:center;">No active alerts üéâ</td></tr>';
            return;
        }
        alerts.forEach(a=>{
            const tr=document.createElement('tr');
            tr.className=a.type==='HIGH_VALUE_NO_CONTACT'?'alert-row critical':
                         a.type==='PAYMENT_DELAY'?'alert-row high':'';
            tr.innerHTML=`
                <td>${a.type.replace(/_/g,' ')}</td>
                <td>${a.client_name}</td>
                <td>${a.outstanding_amount.toLocaleString('en-US')}</td>
                <td>${a.days_since_contact}</td>
                <td>${a.collector || '-'}</td>`;
            body.appendChild(tr);
        });
    }

    function buildCollectorTable(statsObj){
        const body=document.querySelector('#collectorsTable tbody');
        body.innerHTML='';
        const stats = Object.entries(statsObj)
            .sort(([,a],[,b]) => b.performance_score - a.performance_score);
        stats.forEach(([name,s])=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`
                <td>${name}</td>
                <td>${s.total_clients}</td>
                <td>${s.outstanding.toLocaleString('en-US')}</td>
                <td>${s.follow_ups_today}</td>
                <td>${s.payments_received || 0}</td>
                <td>${s.logged_in?'‚úÖ':'‚ùå'}</td>`;
            body.appendChild(tr);
        });
    }

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded',loadDashboard);
    </script>
</body>
</html>
