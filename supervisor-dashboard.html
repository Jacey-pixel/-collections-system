<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Supervisor Dashboard ‚Äì Eram International</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        :root {
            --primary: #004a99;
            --danger:  #d32f2f;
            --warning: #f57c00;
            --success: #2e7d32;
            --bg-light:#f8f9fa;
        }
        body        { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-light); }
        header      { background: var(--primary); color: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2, h3 { margin: 0; }
        .btn-group  { display: flex; gap: 0.5rem; align-items: center; }
        .refresh-btn { background: #27ae60; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .refresh-btn:hover { background: #219150; }
        .logout-btn { background: var(--danger); color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .logout-btn:hover { background: #b71c1c; }
        .wrapper   { padding: 1.5rem; max-width: 1400px; margin: auto; }
        .kpi-grid  { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; }
        .kpi-box   { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-label { font-size: .85rem; color: #666; }
        .kpi-value { font-size: 1.6rem; font-weight: bold; margin-top: .25rem; }
        .tabs      { margin-top: 2rem; display: flex; gap: .5rem; border-bottom: 2px solid var(--primary); }
        .tab-btn   { flex-grow: 1; padding: .75rem; border: 1px solid #ccc; border-bottom: none; background:#eee; cursor:pointer; text-align:center; border-radius: 6px 6px 0 0; font-weight: bold; transition: 0.2s; }
        .tab-btn.active{ background: var(--primary); color:#fff; border-color: var(--primary); }
        .section   { display: none; margin-top: -1px; background:#fff; border:1px solid #ccc; border-radius:0 0 6px 6px; padding:1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section.active { display: block; }
        table      { width:100%; border-collapse: collapse; margin-top:.75rem; }
        th,td      { border:1px solid #ddd; padding:.5rem .6rem; font-size:.85rem; text-align: left;}
        th         { background:#f2f2f2; position: sticky; top: 0; }
        #loading   { text-align:center; padding:2rem; font-size:1.1rem; color:#666; font-style: italic; }
        .user-info  { display: flex; align-items: center; gap: 1rem; }
        .alert-row.high    { background:#fff3e0; }
        .alert-row.critical{ background:#ffebee; }
        .badge      { display:inline-block; padding:.2rem .5rem; border-radius:4px; font-size:.75rem; font-weight:bold; }
        .bg-danger  { background:var(--danger);  color:#fff; }
        .bg-warning { background:var(--warning); color:#fff; }
        .bg-success { background:var(--success); color:#fff; }
        .reporting-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 1rem; }
        @media (max-width: 900px) { .reporting-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Supervisor Dashboard</h1>
            <h2 style="font-size:1rem; font-weight: normal;">Real-time Collections Overview</h2>
        </div>
        <div class="user-info">
            <span id="supervisorName">Checking Session...</span>
            <div class="btn-group">
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <div id="kpiSection" class="kpi-grid" style="display:none;"></div>

        <div class="tabs">
            <div id="alertsTab" class="tab-btn active" onclick="switchTab('alerts')">System Alerts</div>
            <div id="collectorsTab" class="tab-btn" onclick="switchTab('collectors')">Collector Performance</div>
            <div id="systemTab" class="tab-btn" onclick="switchTab('system')">System Health</div>
            <div id="reportingTab" class="tab-btn" onclick="switchTab('reporting')">Monthly Reporting</div>
        </div>

        <div id="alertsSection" class="section active">
            <h3>üîî Active Alerts</h3>
            <table id="alertsTable">
                <thead>
                    <tr>
                        <th>Severity</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Client/Collector</th>
                        <th>Financial Impact</th>
                        <th>Action Required</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="collectorsSection" class="section">
            <h3>üë§ Collector Performance</h3>
            <table id="collectorsTable">
                <thead>
                    <tr>
                        <th>Collector</th>
                        <th>Clients</th>
                        <th>Ref Portfolio (SAR)</th>
                        <th>Outstanding (SAR)</th>
                        <th>YTD Collections</th>
                        <th>Follow-ups</th>
                        <th>Payments Today (Amt)</th>
                        <th>Payments Today (Count)</th>
                        <th>Promises</th>
                        <th>Logged-in</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="systemSection" class="section">
            <h3>‚öôÔ∏è System Health</h3>
            <div class="kpi-grid">
                <div class="kpi-box">
                    <div class="kpi-label">Active Collectors</div>
                    <div class="kpi-value" id="activeCollectors">-</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Pending Reminders</div>
                    <div class="kpi-value" id="pendingReminders">-</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">System Efficiency</div>
                    <div class="kpi-value" id="systemEfficiency">-</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Total Follow-ups Today</div>
                    <div class="kpi-value" id="totalFollowupsToday">-</div>
                </div>
            </div>
        </div>

        <div id="reportingSection" class="section">
            <h3>üìà Monthly Collections Reporting</h3>
            <div class="reporting-grid">
                <div>
                    <h4>Overall Monthly Collections</h4>
                    <table id="overallMonthlyTable">
                        <thead><tr><th>Month</th><th>Total Collected (SAR)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h4>Collections by Collector</h4>
                    <table id="collectorMonthlyTable">
                        <thead><tr><th>Collector</th><th>Monthly Breakdown</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="loading">Loading dashboard data‚Ä¶</div>
    </div>

    <script>
    const CONFIG = {
        API_URL: 'https://eram-intl.app.n8n.cloud/webhook/supervisor-data',
        BASE_URL: 'https://jacey-pixel.github.io/eram-collections-system',
        LOGIN_PAGE: 'supervisor-login.html',
        TOKEN_KEY: 'supervisorToken',
        USER_INFO_KEY: 'supervisorInfo'
    };

    function switchTab(target){
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(target + 'Tab').classList.add('active');
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        document.getElementById(target + 'Section').classList.add('active');
    }

    function validateSession() {
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);
        const userInfo = localStorage.getItem(CONFIG.USER_INFO_KEY);
        
        if (!token || !userInfo) { 
            redirectToLogin(); 
            return false; 
        }
        
        try {
            const parsedUserInfo = JSON.parse(userInfo);
            document.getElementById('supervisorName').textContent =
                parsedUserInfo.name || parsedUserInfo.email;
            return true;
        } catch (error) { 
            redirectToLogin(); 
            return false; 
        }
    }

    function redirectToLogin() {
        localStorage.clear();
        window.location.replace(`${CONFIG.BASE_URL}/${CONFIG.LOGIN_PAGE}`);
    }

    async function loadDashboard(){
        if (!validateSession()) return;
        
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);
        const userInfo = JSON.parse(localStorage.getItem(CONFIG.USER_INFO_KEY));
        
        const loader = document.getElementById('loading');
        loader.style.display = 'block';
        loader.innerText = 'Syncing latest collections data...';

        try {
            const res = await fetch(CONFIG.API_URL, {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'X-Supervisor-Email': userInfo.email, 
                    'Content-Type': 'application/json'
                },
                cache: 'no-store'
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            
            buildKPIs(data.kpis);
            buildAlerts(data.alerts);
            buildCollectorTable(data.collector_performance);
            buildSystemHealth(data.system_health);
            buildMonthlyReporting(data.monthly_reporting);

            loader.style.display = 'none';
            document.getElementById('kpiSection').style.display = 'grid';
            
        } catch(err) {
            console.error('Dashboard error:', err);
            loader.innerText = 'Error loading data. Retrying in 5s...';
            setTimeout(loadDashboard, 5000);
        }
    }

    function buildKPIs(kpis){
        const wrap = document.getElementById('kpiSection');
        wrap.innerHTML = '';
        if(!kpis) return;

        const entries = [
            {label: 'Total Portfolio',    val: (kpis.total_portfolio || 0).toLocaleString() + ' SAR'},
            {label: 'Total Overdue',      val: (kpis.total_overdue || 0).toLocaleString() + ' SAR', cls: 'bg-danger'},
            {label: 'High Value Clients', val: kpis.high_value_clients || 0, cls: 'bg-warning'},
            {label: 'Payments Today',     val: (kpis.payments_today || 0).toLocaleString() + ' SAR', cls: 'bg-success'}
        ];

        entries.forEach(e => {
            const box = document.createElement('div');
            box.className = 'kpi-box';
            box.innerHTML = `
                <div class="kpi-label">${e.label}</div>
                <div class="kpi-value">
                    ${e.cls ? `<span class="badge ${e.cls}">${e.val}</span>` : e.val}
                </div>`;
            wrap.appendChild(box);
        });
    }

    function buildAlerts(alerts){
        const body = document.querySelector('#alertsTable tbody');
        body.innerHTML = '';
        if (!alerts || !alerts.length) {
            body.innerHTML =
                '<tr><td colspan="6" style="text-align:center;">No active alerts üéâ</td></tr>';
            return;
        }
        alerts.forEach(alert => {
            const tr = document.createElement('tr');
            tr.className = alert.severity === 'CRITICAL'
                ? 'alert-row critical'
                : alert.severity === 'HIGH'
                ? 'alert-row high'
                : '';
            const badge = alert.severity === 'CRITICAL'
                ? 'bg-danger'
                : alert.severity === 'HIGH'
                ? 'bg-warning'
                : 'bg-success';
            tr.innerHTML = `
                <td><span class="badge ${badge}">${alert.severity}</span></td>
                <td>${alert.type.replace(/_/g, ' ')}</td>
                <td>${alert.description}</td>
                <td>${alert.client_name || alert.collector || '-'}</td>
                <td>${alert.financial_impact ? alert.financial_impact.toLocaleString() + ' SAR' : '-'}</td>
                <td>${alert.action_required}</td>`;
            body.appendChild(tr);
        });
    }

    function buildCollectorTable(perf) {
        const body = document.querySelector('#collectorsTable tbody');
        body.innerHTML = '';
        if (!perf) return;

        Object.entries(perf).forEach(([name, stats]) => {
            const tr = document.createElement('tr');
            const icon = stats.logged_in_today ? 'üü¢' : 'üî¥';
            const paymentsAmt   = (stats.payments_today_amount || 0).toLocaleString();
            const paymentsCount = stats.payments_today_count || 0;

            tr.innerHTML = `
                <td>${icon} <strong>${name}</strong></td>
                <td>${stats.total_clients || 0}</td>
                <td>${(stats.reference_portfolio || 0).toLocaleString()}</td>
                <td>${(stats.outstanding_amount || 0).toLocaleString()}</td>
                <td>${(stats.ytd_collections || 0).toLocaleString()}</td>
                <td>${stats.follow_ups_today || 0}</td>
                <td>${paymentsAmt}</td>
                <td>${paymentsCount}</td>
                <td>${stats.promises_today || 0}</td>
                <td>${stats.logged_in_today ? 'Yes' : 'No'}</td>
                <td>${stats.last_activity || 'N/A'}</td>`;
            body.appendChild(tr);
        });
    }

    function buildSystemHealth(sh) {
        if (!sh) return;
        document.getElementById('activeCollectors').textContent =
            `${sh.active_collectors_today}/${sh.total_collectors}`;
        document.getElementById('pendingReminders').textContent =
            sh.total_reminders_pending;
        document.getElementById('systemEfficiency').textContent =
            typeof sh.system_efficiency === 'number'
                ? sh.system_efficiency.toString() + '%'
                : '-';
        document.getElementById('totalFollowupsToday').textContent =
            sh.total_follow_ups_today;
    }

    function buildMonthlyReporting(data) {
        if (!data) return;

        const overallBody = document.querySelector('#overallMonthlyTable tbody');
        overallBody.innerHTML = '';
        Object.keys(data.overall || {}).sort().reverse().forEach(m => {
            overallBody.innerHTML += `
                <tr>
                    <td>${m}</td>
                    <td>${data.overall[m].toLocaleString()} SAR</td>
                </tr>`;
        });

        const collectorBody = document.querySelector('#collectorMonthlyTable tbody');
        collectorBody.innerHTML = '';

        const byCollector = data.by_collector || {};
        const monthsSet = new Set();
        Object.values(byCollector).forEach(monthsObj => {
            Object.keys(monthsObj || {}).forEach(m => monthsSet.add(m));
        });
        const sortedMonths = Array.from(monthsSet).sort().reverse();

        Object.entries(byCollector).forEach(([collectorName, monthsObj]) => {
            const parts = [];
            sortedMonths.forEach(m => {
                if (monthsObj[m]) {
                    parts.push(`${m}: ${monthsObj[m].total.toLocaleString()} SAR`);
                }
            });
            const breakdown = parts.length ? parts.join(' | ') : '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${collectorName}</td><td>${breakdown}</td>`;
            collectorBody.appendChild(tr);
        });
    }

    function logout() {
        redirectToLogin();
    }
    
    setInterval(loadDashboard, 150000); 
    document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>


