<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Supervisor Dashboard ‚Äì Eram International</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Prevent GitHub Pages 404/Caching issues on redirect -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        :root {
            --primary: #004a99;
            --danger:  #d32f2f;
            --warning: #f57c00;
            --success: #2e7d32;
            --bg-light:#f8f9fa;
        }
        body        { margin: 0; font-family: Arial, sans-serif; background: var(--bg-light); }
        header      { background: var(--primary); color: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        h1, h2, h3 { margin: 0; }
        .btn-group  { display: flex; gap: 0.5rem; align-items: center; }
        .refresh-btn { background: #27ae60; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .refresh-btn:hover { background: #219150; }
        .logout-btn { background: var(--danger); color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background: #b71c1c; }
        .wrapper   { padding: 1.5rem; max-width: 1400px; margin: auto; }
        .kpi-grid  { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; }
        .kpi-box   { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1rem; text-align: center; }
        .kpi-label { font-size: .85rem; color: #666; }
        .kpi-value { font-size: 1.6rem; font-weight: bold; margin-top: .25rem; }
        .tabs      { margin-top: 2rem; display: flex; gap: .5rem; border-bottom: 2px solid var(--primary); }
        .tab-btn   { flex-grow: 1; padding: .75rem; border: 1px solid #ccc; border-bottom: none; background:#eee; cursor:pointer; text-align:center; border-radius: 6px 6px 0 0; font-weight: bold; }
        .tab-btn.active{ background: var(--primary); color:#fff; border-color: var(--primary); }
        .section   { display: none; margin-top: -1px; background:#fff; border:1px solid #ccc; border-radius:0 0 6px 6px; padding:1.5rem; }
        .section.active { display: block; }
        table      { width:100%; border-collapse: collapse; margin-top:.75rem; }
        th,td      { border:1px solid #ddd; padding:.5rem .6rem; font-size:.85rem; text-align: left;}
        th         { background:#f2f2f2; }
        #loading   { text-align:center; padding:2rem; font-size:1.1rem; color:#666; }
        .user-info  { display: flex; align-items: center; gap: 1rem; }
        .alert-row.high    { background:#fff3e0; }
        .alert-row.critical{ background:#ffebee; }
        .badge      { display:inline-block; padding:.2rem .5rem; border-radius:4px; font-size:.75rem; font-weight:bold; }
        .bg-danger  { background:var(--danger);  color:#fff; }
        .bg-warning { background:var(--warning); color:#fff; }
        .bg-success { background:var(--success); color:#fff; }
        .reporting-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 1rem; }
        @media (max-width: 900px) { .reporting-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Supervisor Dashboard</h1>
            <h2 style="font-size:1rem; font-weight: normal;">Real-time Collections Overview</h2>
        </div>
        <div class="user-info">
            <span id="supervisorName">Loading...</span>
            <div class="btn-group">
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <div id="kpiSection" class="kpi-grid" style="display:none;"></div>

        <div class="tabs">
            <div id="alertsTab" class="tab-btn active" onclick="switchTab('alerts')">System Alerts</div>
            <div id="collectorsTab" class="tab-btn" onclick="switchTab('collectors')">Collector Performance</div>
            <div id="systemTab" class="tab-btn" onclick="switchTab('system')">System Health</div>
            <div id="reportingTab" class="tab-btn" onclick="switchTab('reporting')">Monthly Reporting</div>
        </div>

        <div id="alertsSection" class="section active">
            <h3>üîî Active Alerts</h3>
            <table id="alertsTable">
                <thead><tr><th>Severity</th><th>Type</th><th>Description</th><th>Client/Collector</th><th>Financial Impact</th><th>Action Required</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="collectorsSection" class="section">
            <h3>üë§ Collector Performance</h3>
            <table id="collectorsTable">
                <thead>
                    <tr>
                        <th>Collector</th>
                        <th>Clients</th>
                        <th>Reference Portfolio (SAR)</th>
                        <th>Portfolio (SAR)</th>
                        <th>YTD Collections (SAR)</th>
                        <th>Follow-ups Today</th>
                        <th>Payments Today</th>
                        <th>Promises Made</th>
                        <th>Logged-in</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="systemSection" class="section">
            <h3>‚öôÔ∏è System Health</h3>
            <div class="kpi-grid">
                <div class="kpi-box"><div class="kpi-label">Active Collectors</div><div class="kpi-value" id="activeCollectors">-</div></div>
                <div class="kpi-box"><div class="kpi-label">Pending Reminders</div><div class="kpi-value" id="pendingReminders">-</div></div>
                <div class="kpi-box"><div class="kpi-label">System Efficiency</div><div class="kpi-value" id="systemEfficiency">-</div></div>
                <div class="kpi-box"><div class="kpi-label">Total Follow-ups Today</div><div class="kpi-value" id="totalFollowupsToday">-</div></div>
            </div>
        </div>

        <div id="reportingSection" class="section">
            <h3>üìà Monthly Collections Reporting</h3>
            <div class="reporting-grid">
                <div>
                    <h4>Overall Monthly Collections</h4>
                    <table id="overallMonthlyTable">
                        <thead><tr><th>Month</th><th>Total Collected (SAR)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h4>Collections by Collector (Monthly)</h4>
                    <table id="collectorMonthlyTable">
                        <thead><tr><th>Collector</th><th>Monthly Breakdown</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="loading">Loading dashboard data‚Ä¶</div>
    </div>

    <script>
    const CONFIG = {
        API_URL: 'https://eram-intl.app.n8n.cloud/webhook/supervisor-data',
        // UPDATED: Points to the new repository name
        LOGIN_URL: 'https://jacey-pixel.github.io/eram-collections-system/supervisor-login.html',
        TOKEN_KEY: 'supervisorToken',
        USER_INFO_KEY: 'supervisorInfo'
    };

    function switchTab(target){
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(target + 'Tab').classList.add('active');
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        document.getElementById(target + 'Section').classList.add('active');
    }

    function validateSession() {
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);
        const userInfo = localStorage.getItem(CONFIG.USER_INFO_KEY);
        if (!token || !userInfo) { redirectToLogin('Session expired. Please log in again.'); return false; }
        try {
            const parsedUserInfo = JSON.parse(userInfo);
            document.getElementById('supervisorName').textContent = parsedUserInfo.name || parsedUserInfo.email;
            return true;
        } catch (error) { redirectToLogin('Invalid session. Please log in again.'); return false; }
    }

    function redirectToLogin(message) {
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        localStorage.removeItem(CONFIG.USER_INFO_KEY);
        // Use replace to prevent "Back" button loops
        window.location.replace(CONFIG.LOGIN_URL);
    }

    async function loadDashboard(){
        if (!validateSession()) return;
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);
        const userInfo = JSON.parse(localStorage.getItem(CONFIG.USER_INFO_KEY));
        
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading').innerText = 'Syncing latest collections data...';

        try{
            const res = await fetch(CONFIG.API_URL, {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'X-Supervisor-Email': userInfo.email, 
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache' 
                }
            });
            if (!res.ok) { throw new Error(`HTTP ${res.status}`); }
            const data = await res.json();
            
            buildKPIs(data.kpis);
            buildAlerts(data.alerts);
            buildCollectorTable(data.collector_performance);
            buildSystemHealth(data.system_health);
            buildMonthlyReporting(data.monthly_reporting);

            document.getElementById('loading').style.display='none';
            document.getElementById('kpiSection').style.display='grid';
            
        } catch(err) {
            console.error('Dashboard loading error:', err);
            document.getElementById('loading').innerText = 'Error loading data. Please check your connection.';
        }
    }

    function buildKPIs(kpis){
        const wrap = document.getElementById('kpiSection');
        wrap.innerHTML = '';
        const entries = [
            {label: 'Total Portfolio', val: (kpis.total_portfolio || 0).toLocaleString('en-US') + ' SAR'},
            {label: 'Total Overdue', val: (kpis.total_overdue || 0).toLocaleString('en-US') + ' SAR', cls: 'bg-danger'},
            {label: 'High Value Clients', val: kpis.high_value_clients || 0, cls: 'bg-warning'},
            {label: 'Payments Today', val: (kpis.payments_today || 0).toLocaleString('en-US') + ' SAR', cls: 'bg-success'}
        ];
        entries.forEach(e => {
            const box = document.createElement('div');
            box.className = 'kpi-box';
            const valDiv = document.createElement('div');
            valDiv.className = 'kpi-value';
            if (e.cls) { 
                const badge = document.createElement('span');
                badge.className = `badge ${e.cls}`;
                badge.textContent = e.val;
                valDiv.appendChild(badge);
            } else { valDiv.textContent = e.val; }
            box.innerHTML = `<div class="kpi-label">${e.label}</div>`;
            box.appendChild(valDiv);
            wrap.appendChild(box);
        });
    }

    function buildAlerts(alerts){
        const body = document.querySelector('#alertsTable tbody');
        body.innerHTML = '';
        if (!alerts || !alerts.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;">No active alerts üéâ</td></tr>'; return; }
        alerts.forEach(alert => {
            const tr = document.createElement('tr');
            tr.className = alert.severity === 'CRITICAL' ? 'alert-row critical' : alert.severity === 'HIGH' ? 'alert-row high' : '';
            const severityBadge = alert.severity === 'CRITICAL' ? 'bg-danger' : alert.severity === 'HIGH' ? 'bg-warning' : 'bg-success';
            tr.innerHTML = `<td><span class="badge ${severityBadge}">${alert.severity}</span></td><td>${alert.type.replace(/_/g, ' ')}</td><td>${alert.description}</td><td>${alert.client_name || alert.collector || '-'}</td><td>${alert.financial_impact ? alert.financial_impact.toLocaleString() + ' SAR' : '-'}</td><td>${alert.action_required}</td>`;
            body.appendChild(tr);
        });
    }

    function buildCollectorTable(collectorPerformance) {
        const body = document.querySelector('#collectorsTable tbody');
        body.innerHTML = '';
        if (!collectorPerformance) return;

        const collectors = Object.entries(collectorPerformance).sort(([, a], [, b]) => {
            const aActive = (a.minutes_since_activity || 999) < 30 ? 1 : 0;
            const bActive = (b.minutes_since_activity || 999) < 30 ? 1 : 0;
            return bActive - aActive || (b.outstanding_amount - a.outstanding_amount);
        });

        collectors.forEach(([name, stats]) => {
            const tr = document.createElement('tr');
            let mins = stats.minutes_since_activity;
            let icon = 'üî¥';
            if (mins < 30) icon = 'üü¢';
            else if (mins < 60) icon = 'üü°';
            else if (mins < 1440) icon = '‚ö™';

            if (mins < 30) tr.style.backgroundColor = '#e8f5e9';

            tr.innerHTML = `
                <td>${icon} <strong>${name}</strong></td>
                <td>${stats.total_clients || 0}</td>
                <td>${(stats.reference_portfolio || 0).toLocaleString()}</td>
                <td>${(stats.outstanding_amount || 0).toLocaleString()}</td>
                <td>${(stats.ytd_collections || 0).toLocaleString()}</td>
                <td>${stats.follow_ups_today || 0}</td>
                <td>${stats.payments_today || 0}</td>
                <td>${stats.promises_today || 0}</td>
                <td>${stats.logged_in_today ? 'Yes' : 'No'}</td>
                <td>${stats.last_activity}</td>
            `;
            body.appendChild(tr);
        });
    }

    function buildSystemHealth(sh) {
        if (!sh) return;
        document.getElementById('activeCollectors').textContent = `${sh.active_collectors_today}/${sh.total_collectors}`;
        document.getElementById('pendingReminders').textContent = sh.total_reminders_pending;
        document.getElementById('systemEfficiency').textContent = sh.system_efficiency + '%';
        document.getElementById('totalFollowupsToday').textContent = sh.total_follow_ups_today;
    }

    function buildMonthlyReporting(data) {
        if (!data) return;
        const overallBody = document.querySelector('#overallMonthlyTable tbody');
        overallBody.innerHTML = '';
        Object.keys(data.overall || {}).sort().reverse().forEach(m => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${m}</td><td>${data.overall[m].toLocaleString()} SAR</td>`;
            overallBody.appendChild(tr);
        });

        const collBody = document.querySelector('#collectorMonthlyTable tbody');
        collBody.innerHTML = '';
        Object.keys(data.by_collector || {}).sort().forEach(c => {
            const tr = document.createElement('tr');
            let breakdown = '';
            Object.keys(data.by_collector[c]).sort().reverse().forEach(m => {
                breakdown += `<details><summary>${m}: ${data.by_collector[c][m].total.toLocaleString()} SAR</summary><ul>` +
                    data.by_collector[c][m].details.map(d => `<li>${d.client_name}: ${d.amount.toLocaleString()}</li>`).join('') + `</ul></details>`;
            });
            tr.innerHTML = `<td><strong>${c}</strong></td><td>${breakdown}</td>`;
            collBody.appendChild(tr);
        });
    }

    function logout() { redirectToLogin('Logged out successfully.'); }
    
    // Auto-refresh every 2.5 minutes
    setInterval(loadDashboard, 150000); 
    document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>





