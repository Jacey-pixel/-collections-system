<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Supervisor Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --primary: #004a99; --danger: #d32f2f; --warning: #f57c00; --success: #2e7d32; --bg: #f8f9fa; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .wrapper { padding: 2rem; max-width: 1400px; margin: auto; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-box { background: white; border-radius: 8px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-val { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
        .tabs { display: flex; border-bottom: 2px solid var(--primary); margin-bottom: 2rem; }
        .tab-btn { padding: 1rem 2rem; border: none; background: #eee; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; margin-right: 5px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .section { display: none; background: white; padding: 2rem; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .section.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        th { background: #f2f2f2; }
        .alert-critical { background: #ffebee; }
    </style>
</head>
<body>
    <header><h1>Supervisor Control</h1> <div><span id="supName">...</span> <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">Logout</button></div></header>
    <div class="wrapper">
        <div class="kpi-grid">
            <div class="kpi-box"><div>Portfolio</div><div class="kpi-val" id="kpiPort">0</div></div>
            <div class="kpi-box"><div>Overdue</div><div class="kpi-val" id="kpiOver" style="color:var(--danger)">0</div></div>
            <div class="kpi-box"><div>Today's Payments</div><div class="kpi-val" id="kpiPay" style="color:var(--success)">0</div></div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('alerts')">Alerts</button>
            <button class="tab-btn" onclick="showTab('collectors')">Collectors</button>
            <button class="tab-btn" onclick="showTab('reporting')">Reporting</button>
        </div>
        <div id="alerts" class="section active"><h3>Active Alerts</h3><table id="alertT"><thead><tr><th>Severity</th><th>Description</th><th>Impact</th></tr></thead><tbody></tbody></table></div>
        <div id="collectors" class="section"><h3>Collector Performance</h3><table id="collT"><thead><tr><th>Collector</th><th>Outstanding</th><th>Collections</th><th>Status</th></tr></thead><tbody></tbody></table></div>
        <div id="reporting" class="section"><h3>Monthly Reporting</h3><table id="repT"><thead><tr><th>Collector</th><th>Monthly Totals</th></tr></thead><tbody></tbody></table></div>
    </div>
<script>
    const token = localStorage.getItem('supervisorToken');
    if(!token) logout();
    
    function showTab(t) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        event.target.classList.add('active');
    }

    async function load() {
        try {
            const res = await fetch('https://eram-intl.app.n8n.cloud/webhook/supervisor-data', {
                headers: { 'X-Session-Token': token }
            });
            const data = await res.json();
            if(!data.success) { if(res.status === 401) logout(); return; }
            document.getElementById('kpiPort').textContent = data.kpis.total_portfolio.toLocaleString() + ' SAR';
            document.getElementById('kpiOver').textContent = data.kpis.total_overdue.toLocaleString() + ' SAR';
            document.getElementById('kpiPay').textContent = data.kpis.payments_today.toLocaleString() + ' SAR';
            
            document.querySelector('#alertT tbody').innerHTML = data.alerts.map(a => `<tr class="alert-${a.severity.toLowerCase()}"><td>${a.severity}</td><td>${a.description}</td><td>${a.financial_impact}</td></tr>`).join('');
            
            document.querySelector('#collT tbody').innerHTML = Object.entries(data.collector_performance).map(([name, s]) => `
                <tr><td>${name}</td><td>${s.outstanding_amount.toLocaleString()}</td><td>${s.ytd_collections.toLocaleString()}</td><td>${s.minutes_since_activity < 30 ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline'}</td></tr>`).join('');
        } catch(e) { console.error(e); }
    }

    function logout() { localStorage.clear(); window.location.href = 'supervisor-login.html'; }
    load();
</script>
</body>
</html>
