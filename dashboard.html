<!DOCTYPE html>
<html>
<head>
    <title>Collections Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .header { background-color: #4CAF50; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #4CAF50; }
        .clients-table { width: 100%; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .clients-table th, .clients-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .clients-table th { background-color: #f8f9fa; font-weight: bold; }
        .priority-high { background-color: #ffebee; }
        .priority-medium { background-color: #fff3e0; }
        .priority-low { background-color: #e8f5e8; }
        .action-btn { background-color: #008CBA; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .action-btn:hover { background-color: #007BB5; }
        .follow-up-form { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .submit-btn { background-color: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .debug-panel { background: #f0f0f0; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Collections Dashboard</h1>
        <p>Welcome, <span id="collectorName"></span> | <span id="currentDate"></span></p>
    </div>
    
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number" id="totalClients">-</div>
            <div>Total Clients</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="overdueClients">-</div>
            <div>Overdue Clients</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalOverdue">-</div>
            <div>Total Overdue (SAR)</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="followUpsToday">-</div>
            <div>Follow-ups Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeReminders">-</div>
            <div>Active Reminders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="remindersSentToday">-</div>
            <div>Reminders Sent Today</div>
        </div>
    </div>
    
    <div class="clients-table">
        <table>
            <thead>
                <tr>
                    <th>Client Code</th>
                    <th>Client Name</th>
                    <th>Outstanding</th>
                    <th>Overdue</th>
                    <th>Priority</th>
                    <th>Last Contact</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
                <!-- Clients will be loaded here -->
            </tbody>
        </table>
    </div>
    
    <!-- DEBUG PANEL -->
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <h4>Debug Information:</h4>
        <div id="debugContent"></div>
    </div>
    
    <div class="follow-up-form" id="followUpForm" style="display: none;">
        <h3>Log Follow-Up</h3>
        <form id="followUpFormElement">
            <div class="form-group">
                <label for="clientSelect">Client:</label>
                <select id="clientSelect" name="client" required>
                    <option value="">Select a client...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contactDate">Contact Date:</label>
                <input type="date" id="contactDate" name="contact_date" required>
            </div>
            <div class="form-group">
                <label for="contactMethod">Contact Method:</label>
                <select id="contactMethod" name="contact_method" required>
                    <option value="">Select method...</option>
                    <option value="Phone Call">Phone Call</option>
                    <option value="Email">Email</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Visit">Visit</option>
                    <option value="SMS">SMS</option>
                </select>
            </div>
            <div class="form-group">
                <label for="outcome">Outcome:</label>
                <select id="outcome" name="outcome" required>
                    <option value="">Select outcome...</option>
                    <option value="No Response">No Response</option>
                    <option value="Payment Promised">Payment Promised</option>
                    <option value="Dispute">Dispute</option>
                    <option value="Partial Payment">Partial Payment</option>
                    <option value="Paid in Full">Paid in Full</option>
                    <option value="Will Call Back">Will Call Back</option>
                    <option value="Meeting Scheduled">Meeting Scheduled</option>
                </select>
            </div>
            <div class="form-group" id="promisedAmountGroup" style="display: none;">
                <label for="promisedAmount">Promised Amount (SAR):</label>
                <input type="number" id="promisedAmount" name="promised_amount" min="0" step="0.01">
            </div>
            <div class="form-group" id="nextFollowUpGroup" style="display: none;">
                <label for="nextFollowUp">Next Follow-Up Date:</label>
                <input type="date" id="nextFollowUp" name="next_follow_up">
            </div>
            <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Additional comments..."></textarea>
            </div>
            <button type="submit" class="submit-btn">Submit Follow-Up</button>
            <button type="button" class="action-btn" onclick="hideFollowUpForm()">Cancel</button>
            <button type="button" class="action-btn" onclick="toggleDebug()">Show Debug</button>
        </form>
    </div>

    <script>
        // Get collector name from URL - ENHANCED WITH VALIDATION
        const urlParams = new URLSearchParams(window.location.search);
        const collectorName = urlParams.get('collector');

        console.log('=== DASHBOARD INITIALIZATION ===');
        console.log('URL parameters:', window.location.search);
        console.log('Collector name from URL:', collectorName);

        if (!collectorName) {
            console.error('No collector parameter found in URL');
            alert('Error: No collector specified. Please login again.');
            window.location.href = 'https://jacey-pixel.github.io/-collections-system/login.html';
        }

        document.getElementById('collectorName').textContent = collectorName || 'Unknown';
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        document.getElementById('contactDate').value = new Date().toISOString().split('T')[0];
        
        // Debug functions
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateDebug(message) {
            const content = document.getElementById('debugContent');
            content.innerHTML += message + '<br>';
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log('Loading dashboard data for collector:', collectorName);
                updateDebug(`Loading dashboard for: ${collectorName}`);
                
                // Fetch client data for this collector
                const clientResponse = await fetch(`https://jowan13.app.n8n.cloud/webhook/client-data?collector=${collectorName}`);
                const clientData = await clientResponse.json();
                
                console.log('Client data received:', clientData);
                updateDebug(`Client data loaded: ${clientData.clients ? clientData.clients.length : 0} clients`);
                
                // Fetch enhanced statistics
                const statsResponse = await fetch(`https://jowan13.app.n8n.cloud/webhook/dashboard-stats?collector=${collectorName}`);
                const statsData = await statsResponse.json();
                
                console.log('Stats data received:', statsData);
                
                updateStats(statsData);
                loadClientsTable(clientData.clients);
                loadClientSelect(clientData.clients);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                updateDebug(`Error loading dashboard: ${error.message}`);
            }
        }
        
        function updateStats(data) {
            document.getElementById('totalClients').textContent = data.total_clients || 0;
            document.getElementById('overdueClients').textContent = data.overdue_clients || 0;
            document.getElementById('totalOverdue').textContent = (data.total_overdue || 0).toLocaleString();
            document.getElementById('followUpsToday').textContent = data.follow_ups_today || 0;
            
            // Enhanced stats from Dashboard_Stats_API
            document.getElementById('activeReminders').textContent = data.active_reminders || 0;
            document.getElementById('remindersSentToday').textContent = data.reminders_sent_today || 0;
        }
        
        function loadClientsTable(clients) {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';
            
            if (!clients || clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No clients found for this collector</td></tr>';
                return;
            }
            
            clients.forEach(client => {
                const priority = client.overdue > 100000 ? 'HIGH' : 
                               client.overdue > 50000 ? 'MEDIUM' : 'LOW';
                const priorityClass = priority === 'HIGH' ? 'priority-high' : 
                                    priority === 'MEDIUM' ? 'priority-medium' : 'priority-low';
                
                const row = document.createElement('tr');
                row.className = priorityClass;
                row.innerHTML = `
                    <td>${client.code}</td>
                    <td>${client.name}</td>
                    <td>${client.outstanding.toLocaleString()}</td>
                    <td>${client.overdue.toLocaleString()}</td>
                    <td><strong>${priority}</strong></td>
                    <td>${client.last_contact || 'Never'}</td>
                    <td>
                        <button class="action-btn" onclick="showFollowUpForm('${client.code}')">
                            Log Follow-Up
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function loadClientSelect(clients) {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">Select a client...</option>';
            
            if (!clients || clients.length === 0) {
                select.innerHTML = '<option value="">No clients available</option>';
                return;
            }
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.code;
                option.textContent = `${client.code} - ${client.name}`;
                select.appendChild(option);
            });
        }
        
        function showFollowUpForm(clientCode = '') {
            document.getElementById('followUpForm').style.display = 'block';
            if (clientCode) {
                document.getElementById('clientSelect').value = clientCode;
                updateDebug(`Form opened for client: ${clientCode}`);
            }
            document.getElementById('followUpForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideFollowUpForm() {
            document.getElementById('followUpForm').style.display = 'none';
        }
        
        // Show/hide conditional fields
        document.getElementById('outcome').addEventListener('change', function() {
            const outcome = this.value;
            const promisedGroup = document.getElementById('promisedAmountGroup');
            const followUpGroup = document.getElementById('nextFollowUpGroup');
            
            if (outcome === 'Payment Promised') {
                promisedGroup.style.display = 'block';
                followUpGroup.style.display = 'block';
            } else if (outcome === 'No Response' || outcome === 'Will Call Back') {
                promisedGroup.style.display = 'none';
                followUpGroup.style.display = 'block';
            } else {
                promisedGroup.style.display = 'none';
                followUpGroup.style.display = 'none';
            }
        });
        
        // Handle form submission - ENHANCED WITH DEBUGGING
        document.getElementById('followUpFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // CRITICAL: Debug all form data
            console.log('=== FORM DATA DEBUG ===');
            console.log('Collector from URL:', collectorName);
            updateDebug('=== FORM SUBMISSION DEBUG ===');
            updateDebug(`Collector: ${collectorName}`);
            
            for (let [key, value] of formData.entries()) {
                console.log(`Form field "${key}": "${value}"`);
                updateDebug(`${key}: "${value}"`);
            }
            
            // Build data object with validation
            const data = {
                collector: collectorName || 'MISSING_COLLECTOR',
                client_code: formData.get('client') || 'MISSING_CLIENT',
                contact_date: formData.get('contact_date') || new Date().toISOString().split('T')[0],
                contact_method: formData.get('contact_method') || 'MISSING_METHOD',
                outcome: formData.get('outcome') || 'MISSING_OUTCOME',
                promised_amount: formData.get('promised_amount') || '',
                next_follow_up: formData.get('next_follow_up') || '',
                notes: formData.get('notes') || '',
                timestamp: new Date().toISOString()
            };
            
            console.log('=== SENDING TO API ===');
            console.log('Final data object:', JSON.stringify(data, null, 2));
            updateDebug('Data being sent: ' + JSON.stringify(data, null, 2));
            
            // Validate critical fields
            if (!data.collector || data.collector === 'MISSING_COLLECTOR') {
                alert('Error: Collector name not found. Please refresh and try again.');
                return;
            }
            
            if (!data.client_code || data.client_code === 'MISSING_CLIENT') {
                alert('Error: Please select a client.');
                return;
            }
            
            try {
                console.log('Making API call to:', 'https://jowan13.app.n8n.cloud/webhook/follow-up');
                updateDebug('Making API call...');
                
                const response = await fetch('https://jowan13.app.n8n.cloud/webhook/follow-up', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('API Response status:', response.status);
                updateDebug(`API Response status: ${response.status}`);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('API Success response:', responseText);
                    updateDebug(`API Success: ${responseText}`);
                    alert('Follow-up logged successfully!');
                    this.reset();
                    hideFollowUpForm();
                    loadDashboard(); // Refresh data
                } else {
                    const errorText = await response.text();
                    console.error('API Error response:', errorText);
                    updateDebug(`API Error: ${response.status} - ${errorText}`);
                    alert(`Error logging follow-up: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Network error:', error);
                updateDebug(`Network error: ${error.message}`);
                alert(`Network error: ${error.message}`);
            }
        });
        
        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>

