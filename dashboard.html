<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collections Dashboard – Eram International</title>
    <!-- Prevent GitHub Pages 404/Caching issues -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background-color: #f5f5f5; color: #333; }
        .header { background-color: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { background-color: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .logout-btn:hover { background-color: #c0392b; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        #loadingMessage { text-align: center; padding: 2rem; color: #7f8c8d; font-style: italic; }
        #errorMessage, #successMessage { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-weight: bold; display: none; }
        #errorMessage { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #successMessage { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .kpi-value { font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin-bottom: 0.5rem; }
        .kpi-label { color: #7f8c8d; font-size: 0.85rem; }
        .kpi-value.danger { color: #e74c3c; }
        .kpi-value.success { color: #27ae60; }
        .section { background: white; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-header { background-color: #34495e; color: white; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: bold; }
        .section-content { padding: 1.5rem; overflow-x: auto; }
        .client-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .client-table th, .client-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ecf0f1; font-size: 0.85rem; }
        .client-table th { background-color: #f8f9fa; font-weight: bold; color: #2c3e50; }
        .priority-badge { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
        .priority-badge.high { background-color: #e74c3c; }
        .priority-badge.medium { background-color: #f39c12; }
        .priority-badge.low { background-color: #27ae60; }
        .select-btn { background-color: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .select-btn:hover { background-color: #2980b9; }
        #followUpForm { display: none; background-color: #ecf0f1; padding: 2rem; border-radius: 8px; margin-top: 2rem; border: 1px solid #bdc3c7; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .submit-btn { background-color: #27ae60; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .submit-btn:hover { background-color: #219150; }
        .cancel-btn { background-color: #95a5a6; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; margin-left: 1rem; transition: 0.3s; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Collections Dashboard</h1>
        <div class="user-info">
            <span id="collectorName">Authenticating...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="dashboard-container">
        <div id="loadingMessage">Loading dashboard data...</div>
        <div id="errorMessage"></div>
        <div id="successMessage"></div>

        <div id="dashboardContent" style="display: none;">
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-value" id="totalClients">0</div><div class="kpi-label">Clients</div></div>
                <div class="kpi-card"><div class="kpi-value" id="totalOutstanding">0 SAR</div><div class="kpi-label">Outstanding</div></div>
                <div class="kpi-card"><div class="kpi-value danger" id="totalOverdue">0 SAR</div><div class="kpi-label">Overdue</div></div>
                <div class="kpi-card"><div class="kpi-value success" id="contactedToday">0</div><div class="kpi-label">Contacted Today</div></div>
                <div class="kpi-card"><div class="kpi-value" id="performanceScore">0</div><div class="kpi-label">Score</div></div>
            </div>

            <div class="section">
                <div class="section-header">Your Clients (Priority Sorted)</div>
                <div class="section-content">
                    <table class="client-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Outstanding</th>
                                <th>Overdue</th>
                                <th>Priority</th>
                                <th>Last Contact</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="clientTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="followUpForm">
                <h3>Log Follow-up Activity</h3>
                <form id="followUpFormElement">
                    <div class="form-row">
                        <div class="form-group"><label>Client ID</label><input type="text" id="selectedClientId" readonly></div>
                        <div class="form-group"><label>Client Name</label><input type="text" id="selectedClientName" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Outcome</label>
                            <select id="outcome" required>
                                <option value="">Select Outcome</option>
                                <option value="PHYSICAL_VISIT">Physical Visit</option> 
                                <option value="PROMISE_TO_PAY">Promise to Pay</option>
                                <option value="PAYMENT_CONFIRMED">Payment Confirmed</option>
                                <option value="CALL_BACK_LATER">Call Back Later</option>
                                <option value="NO_RESPONSE">No Response</option>
                                <option value="DISPUTE">Dispute</option>
                                <option value="OTHERS">Others</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Amount Discussed (SAR)</label><input type="number" id="amountDiscussed" step="0.01"></div>
                    </div>
                    <div class="form-group"><label>Notes</label><textarea id="notes" placeholder="Enter details..."></textarea></div>
                    <button type="submit" class="submit-btn">Log Follow-up</button>
                    <button type="button" class="cancel-btn" onclick="cancelFollowUp()">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    // ✅ CRITICAL CONFIG: Using Absolute URLs
    const CONFIG = {
        API_URL: 'https://eram-intl.app.n8n.cloud/webhook/collector-data',
        LOG_URL: 'https://eram-intl.app.n8n.cloud/webhook/log-followup',
        BASE_URL: 'https://jacey-pixel.github.io/eram-collections-system',
        LOGIN_PAGE: 'login.html'
    };

    // Initialize session variables
    let sessionToken = localStorage.getItem('sessionToken');
    let userInfo = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Safe Parse of User Info
        try {
            const storedUser = localStorage.getItem('userInfo');
            if (storedUser) userInfo = JSON.parse(storedUser);
        } catch (e) { console.error("Session parse error"); }

        // Security Check
        if (!sessionToken || !userInfo) {
            logout();
            return;
        }

        document.getElementById('collectorName').textContent = userInfo.name || "Collector";
        loadDashboardData();
        checkClosingTime();
        document.getElementById('followUpFormElement').addEventListener('submit', handleFollowUpSubmission);
    });

    function checkClosingTime() {
        if (new Date().getHours() >= 17) {
            alert("Business hours ended (5 PM). Logging out...");
            logout();
        }
    }

    async function loadDashboardData() {
        try {
            const res = await fetch(CONFIG.API_URL, {
                headers: { 
                    'Authorization': `Bearer ${sessionToken}`, 
                    'X-Collector-Email': userInfo.email,
                    'Cache-Control': 'no-cache'
                }
            });
            const data = await res.json();
            if (data.success) {
                populateDashboard(data);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            } else {
                showError('Session invalid. Please log in again.');
                setTimeout(logout, 2000);
            }
        } catch (e) { showError('Failed to load data. Please refresh.'); }
    }

    function populateDashboard(data) {
        document.getElementById('totalClients').textContent = data.kpis.total_clients;
        document.getElementById('totalOutstanding').textContent = (data.kpis.total_outstanding || 0).toLocaleString() + ' SAR';
        document.getElementById('totalOverdue').textContent = (data.kpis.total_overdue || 0).toLocaleString() + ' SAR';
        document.getElementById('contactedToday').textContent = data.kpis.contacted_today;
        document.getElementById('performanceScore').textContent = data.kpis.performance_score;
        
        const tbody = document.getElementById('clientTableBody');
        tbody.innerHTML = '';
        data.clients.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.client_id}</td>
                <td>${c.client_name}</td>
                <td>${(c.outstanding_amount || 0).toLocaleString()}</td>
                <td style="color:red;font-weight:bold">${(c.overdue_amount || 0).toLocaleString()}</td>
                <td><span class="priority-badge ${c.priority.toLowerCase()}">${c.priority}</span></td>
                <td>${c.last_contact ? c.last_contact.days_ago + ' days' : 'Never'}</td>
                <td><button class="select-btn" onclick="selectClient('${c.client_id}', '${c.client_name.replace(/'/g, "\\'")}')">Select</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function selectClient(id, name) {
        document.getElementById('selectedClientId').value = id;
        document.getElementById('selectedClientName').value = name;
        document.getElementById('followUpForm').style.display = 'block';
        document.getElementById('followUpForm').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelFollowUp() { document.getElementById('followUpForm').style.display = 'none'; }

    async function handleFollowUpSubmission(e) {
        e.preventDefault();
        const payload = {
            client_id: document.getElementById('selectedClientId').value,
            outcome: document.getElementById('outcome').value,
            notes: document.getElementById('notes').value,
            collector_email: userInfo.email,
            amount_discussed: parseFloat(document.getElementById('amountDiscussed').value) || 0
        };
        try {
            const res = await fetch(CONFIG.LOG_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionToken}` },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.success) {
                showSuccess('Follow-up recorded!');
                cancelFollowUp();
                loadDashboardData();
            }
        } catch (e) { showError('Submission failed. Check network.'); }
    }

    function logout() {
        localStorage.clear();
        // Force redirect to the absolute login URL to prevent 404s
        window.location.replace(`${CONFIG.BASE_URL}/${CONFIG.LOGIN_PAGE}`);
    }

    function showError(m) { const d = document.getElementById('errorMessage'); d.textContent = m; d.style.display = 'block'; setTimeout(() => d.style.display = 'none', 5000); }
    function showSuccess(m) { const d = document.getElementById('successMessage'); d.textContent = m; d.style.display = 'block'; setTimeout(() => d.style.display = 'none', 5000); }
    </script>
</body>
</html>





