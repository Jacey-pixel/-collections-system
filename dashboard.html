<!DOCTYPE html>
<html>
<head>
    <title>Collections Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #4a90e2, #50e3c2); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; }
        .header p { margin: 5px 0 0; opacity: 0.9; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .stat-label { color: #666; font-size: 0.9em; margin-top: 10px; }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #4a90e2; }
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .clients-table { width: 100%; border-collapse: collapse; }
        .clients-table th, .clients-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e1e8ed; }
        .clients-table th { background-color: #f8f9fa; font-weight: 600; color: #333; }
        .priority-high { background-color: #ffebee; font-weight: bold; }
        .action-btn { background-color: #4a90e2; color: white; padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #357ABD; }
        .follow-up-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .follow-up-form { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .follow-up-form h2 { margin-top: 0; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        .form-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .submit-btn { flex: 1; background-color: #50e3c2; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; }
        .cancel-btn { flex: 1; background-color: #f3f3f3; color: #333; padding: 12px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; font-size: 1em; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #4CAF50; color: white; padding: 15px; border-radius: 8px; z-index: 1001; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; }
        .notification.error { background-color: #f44336; }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div class="container">
        <div class="header">
            <h1>Collections Dashboard</h1>
            <p>Welcome, <strong id="collectorName"></strong> | <span id="currentDate"></span></p>
        </div>
        
        <div class="stats-row" id="statsRow">
            <!-- Populated by JS -->
        </div>
        
        <div class="table-container">
            <table class="clients-table">
                <thead><tr><th>Client Code</th><th>Name</th><th>Outstanding</th><th>Overdue</th><th>Priority</th><th>Last Contact</th><th>Action</th></tr></thead>
                <tbody id="clientsTableBody"></tbody>
            </table>
        </div>
    </div>
    
    <div class="follow-up-modal" id="followUpModal">
        <div class="follow-up-form">
            <h2>Log Follow-Up for <span id="formClientName"></span></h2>
            <form id="followUpFormElement">
                <input type="hidden" id="formClientCode" name="client_code">
                <div class="form-group">
                    <label for="outcome">Outcome:</label>
                    <select id="outcome" name="outcome" required>
                        <option value="No Response">No Response</option>
                        <option value="Call Back Later">Call Back Later</option>
                        <option value="Payment Promised">Payment Promised</option>
                        <option value="Partial Payment Promised">Partial Payment Promised</option>
                        <option value="Dispute">Dispute</option>
                        <option value="Wrong Contact">Wrong Contact</option>
                    </select>
                </div>
                <div class="form-group" id="nextFollowUpGroup" style="display: none;">
                    <label for="next_follow_up_date">Promised Payment Date:</label>
                    <input type="date" id="next_follow_up_date" name="next_follow_up_date">
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="hideFollowUpForm()">Cancel</button>
                    <button type="submit" class="submit-btn">Submit Follow-Up</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Ensure this is your correct n8n base URL
        const API_BASE_URL = 'https://eram-intl.app.n8n.cloud/webhook'; 
        let currentCollector = '';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentCollector = urlParams.get('collector');

            if (!currentCollector) {
                alert('Error: No collector specified. Redirecting to login.');
                
                // =========================================================
                // THIS LINE HAS BEEN CORRECTED
                // =========================================================
                window.location.href = 'https://jacey-pixel.github.io/-collections-system/login.html';
                
                return;
            }

            document.getElementById('collectorName').textContent = currentCollector;
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB');

            // Add event listeners
            document.getElementById('outcome').addEventListener('change', handleOutcomeChange);
            document.getElementById('followUpFormElement').addEventListener('submit', handleFormSubmit);

            loadDashboard();
        });

        // --- DATA LOADING ---
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/client-data?collector=${currentCollector}`);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                updateStats(data.kpis);
                populateClientsTable(data.clients);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Failed to load dashboard data. Please refresh.', 'error');
            }
        }

        function updateStats(kpis = {}) {
            const statsHtml = `
                <div class="stat-card"><div class="stat-number">${kpis.total_clients || 0}</div><div class="stat-label">Total Clients</div></div>
                <div class="stat-card"><div class="stat-number">${kpis.overdue_clients || 0}</div><div class="stat-label">Overdue Clients</div></div>
                <div class="stat-card"><div class="stat-number">${(kpis.total_overdue || 0).toLocaleString()}</div><div class="stat-label">Total Overdue (SAR)</div></div>
                <div class="stat-card"><div class="stat-number">${kpis.follow_ups_today || 0}</div><div class="stat-label">Follow-ups Today</div></div>
            `;
            document.getElementById('statsRow').innerHTML = statsHtml;
        }

        function populateClientsTable(clients = []) {
            const tableBody = document.getElementById('clientsTableBody');
            tableBody.innerHTML = '';
            if (clients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No clients assigned.</td></tr>';
                return;
            }
            clients.forEach(client => {
                const row = document.createElement('tr');
                if (client.priority === 'High') {
                    row.classList.add('priority-high');
                }
                row.innerHTML = `
                    <td>${client.client_code}</td>
                    <td>${client.client_name}</td>
                    <td>${(client.outstanding_amount || 0).toLocaleString()}</td>
                    <td>${(client.overdue_balance || 0).toLocaleString()}</td>
                    <td>${client.priority}</td>
                    <td>${client.last_contact_date ? new Date(client.last_contact_date).toLocaleDateString('en-GB') : 'N/A'}</td>
                    <td><button class="action-btn" onclick="showFollowUpForm('${client.client_code}', '${client.client_name}')">Log Follow-up</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- FORM HANDLING (These functions are correct) ---
        function showFollowUpForm(clientCode, clientName) { /* ... code is correct ... */ }
        function hideFollowUpForm() { /* ... code is correct ... */ }
        function handleOutcomeChange() { /* ... code is correct ... */ }
        async function handleFormSubmit(event) { /* ... code is correct ... */ }
        function showNotification(message, type = 'success') { /* ... code is correct ... */ }
        
        // --- Functions continued for completeness... ---
        function showFollowUpForm(clientCode, clientName) {
            document.getElementById('formClientName').textContent = clientName;
            document.getElementById('formClientCode').value = clientCode;
            document.getElementById('followUpFormElement').reset();
            handleOutcomeChange();
            document.getElementById('followUpModal').style.display = 'flex';
        }
        function hideFollowUpForm() {
            document.getElementById('followUpModal').style.display = 'none';
        }
        function handleOutcomeChange() {
            const outcome = document.getElementById('outcome').value;
            const nextFollowUpGroup = document.getElementById('nextFollowUpGroup');
            nextFollowUpGroup.style.display = (outcome === 'Payment Promised' || outcome === 'Partial Payment Promised') ? 'block' : 'none';
        }
        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('.submit-btn');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.collector = currentCollector;
            data.client_name = document.getElementById('formClientName').textContent;

            try {
                const response = await fetch(`${API_BASE_URL}/follow-up`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (response.ok) {
                    showNotification('Follow-up logged successfully!');
                    hideFollowUpForm();
                    await loadDashboard();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to log follow-up.');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                showNotification(error.message || 'Network error. Please try again.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Follow-Up';
            }
        }
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>

