<!DOCTYPE html>
<html>
<head>
    <title>Collections Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .header { background-color: #4CAF50; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #4CAF50; }
        .clients-table { width: 100%; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .clients-table th, .clients-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .clients-table th { background-color: #f8f9fa; font-weight: bold; }
        .priority-high { background-color: #ffebee; }
        .priority-medium { background-color: #fff3e0; }
        .priority-low { background-color: #e8f5e8; }
        .action-btn { background-color: #008CBA; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .action-btn:hover { background-color: #007BB5; }
        .follow-up-form { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .submit-btn { background-color: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Collections Dashboard</h1>
        <p>Welcome, <span id="collectorName"></span> | <span id="currentDate"></span></p>
    </div>
    
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number" id="totalClients">-</div>
            <div>Total Clients</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="overdueClients">-</div>
            <div>Overdue Clients</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalOverdue">-</div>
            <div>Total Overdue (SAR)</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="followUpsToday">-</div>
            <div>Follow-ups Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeReminders">-</div>
            <div>Active Reminders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="remindersSentToday">-</div>
            <div>Reminders Sent Today</div>
        </div>
    </div>
    
    <div class="clients-table">
        <table>
            <thead>
                <tr>
                    <th>Client Code</th>
                    <th>Client Name</th>
                    <th>Outstanding</th>
                    <th>Overdue</th>
                    <th>Priority</th>
                    <th>Last Contact</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
                <!-- Clients will be loaded here -->
            </tbody>
        </table>
    </div>
    
    <div class="follow-up-form" id="followUpForm" style="display: none;">
        <h3>Log Follow-Up</h3>
        <form id="followUpFormElement">
            <div class="form-group">
                <label for="clientSelect">Client:</label>
                <select id="clientSelect" name="client" required>
                    <option value="">Select a client...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contactDate">Contact Date:</label>
                <input type="date" id="contactDate" name="contact_date" required>
            </div>
            <div class="form-group">
                <label for="contactMethod">Contact Method:</label>
                <select id="contactMethod" name="contact_method" required>
                    <option value="">Select method...</option>
                    <option value="Call">Call</option>
                    <option value="Email">Email</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Visit">Visit</option>
                    <option value="SMS">SMS</option>
                </select>
            </div>
            <div class="form-group">
                <label for="outcome">Outcome:</label>
                <select id="outcome" name="outcome" required>
                    <option value="">Select outcome...</option>
                    <option value="No Response">No Response</option>
                    <option value="Promised Payment">Promised Payment</option>
                    <option value="Dispute">Dispute</option>
                    <option value="Partial Payment">Partial Payment</option>
                    <option value="Paid in Full">Paid in Full</option>
                    <option value="Will Call Back">Will Call Back</option>
                    <option value="Meeting Scheduled">Meeting Scheduled</option>
                </select>
            </div>
            <div class="form-group" id="promisedAmountGroup" style="display: none;">
                <label for="promisedAmount">Promised Amount (SAR):</label>
                <input type="number" id="promisedAmount" name="promised_amount" min="0" step="0.01">
            </div>
            <div class="form-group" id="nextFollowUpGroup" style="display: none;">
                <label for="nextFollowUp">Next Follow-Up Date:</label>
                <input type="date" id="nextFollowUp" name="next_follow_up">
            </div>
            <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Additional comments..."></textarea>
            </div>
            <button type="submit" class="submit-btn">Submit Follow-Up</button>
            <button type="button" class="action-btn" onclick="hideFollowUpForm()">Cancel</button>
        </form>
    </div>

    <script>
        // Get collector name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const collectorName = urlParams.get('collector');
        
        document.getElementById('collectorName').textContent = collectorName || 'Unknown';
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        document.getElementById('contactDate').value = new Date().toISOString().split('T')[0];
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Fetch client data for this collector
                const clientResponse = await fetch(`https://jowan13.app.n8n.cloud/webhook/client-data?collector=${collectorName}`);
                const clientData = await clientResponse.json();
                
                // Fetch enhanced statistics
                const statsResponse = await fetch(`https://jowan13.app.n8n.cloud/webhook/dashboard-stats?collector=${collectorName}`);
                const statsData = await statsResponse.json();
                
                updateStats(statsData);
                loadClientsTable(clientData.clients);
                loadClientSelect(clientData.clients);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function updateStats(data) {
            document.getElementById('totalClients').textContent = data.total_clients || 0;
            document.getElementById('overdueClients').textContent = data.overdue_clients || 0;
            document.getElementById('totalOverdue').textContent = (data.total_overdue || 0).toLocaleString();
            document.getElementById('followUpsToday').textContent = data.follow_ups_today || 0;
            
            // Enhanced stats from Dashboard_Stats_API
            document.getElementById('activeReminders').textContent = data.active_reminders || 0;
            document.getElementById('remindersSentToday').textContent = data.reminders_sent_today || 0;
        }
        
        function loadClientsTable(clients) {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';
            
            clients.forEach(client => {
                const priority = client.overdue > 100000 ? 'HIGH' : 
                               client.overdue > 50000 ? 'MEDIUM' : 'LOW';
                const priorityClass = priority === 'HIGH' ? 'priority-high' : 
                                    priority === 'MEDIUM' ? 'priority-medium' : 'priority-low';
                
                const row = document.createElement('tr');
                row.className = priorityClass;
                row.innerHTML = `
                    <td>${client.code}</td>
                    <td>${client.name}</td>
                    <td>${client.outstanding.toLocaleString()}</td>
                    <td>${client.overdue.toLocaleString()}</td>
                    <td><strong>${priority}</strong></td>
                    <td>${client.last_contact || 'Never'}</td>
                    <td>
                        <button class="action-btn" onclick="showFollowUpForm('${client.code}')">
                            Log Follow-Up
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function loadClientSelect(clients) {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">Select a client...</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.code;
                option.textContent = `${client.code} - ${client.name}`;
                select.appendChild(option);
            });
        }
        
        function showFollowUpForm(clientCode = '') {
            document.getElementById('followUpForm').style.display = 'block';
            if (clientCode) {
                document.getElementById('clientSelect').value = clientCode;
            }
            document.getElementById('followUpForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideFollowUpForm() {
            document.getElementById('followUpForm').style.display = 'none';
        }
        
        // Show/hide conditional fields
        document.getElementById('outcome').addEventListener('change', function() {
            const outcome = this.value;
            const promisedGroup = document.getElementById('promisedAmountGroup');
            const followUpGroup = document.getElementById('nextFollowUpGroup');
            
            if (outcome === 'Promised Payment') {
                promisedGroup.style.display = 'block';
                followUpGroup.style.display = 'block';
            } else if (outcome === 'No Response' || outcome === 'Will Call Back') {
                promisedGroup.style.display = 'none';
                followUpGroup.style.display = 'block';
            } else {
                promisedGroup.style.display = 'none';
                followUpGroup.style.display = 'none';
            }
        });
        
        // Handle form submission
        document.getElementById('followUpFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                collector: collectorName,
                client_code: formData.get('client'),
                contact_date: formData.get('contact_date'),
                contact_method: formData.get('contact_method'),
                outcome: formData.get('outcome'),
                promised_amount: formData.get('promised_amount'),
                next_follow_up: formData.get('next_follow_up'),
                notes: formData.get('notes'),
                timestamp: new Date().toISOString()
            };
            
            try {
                const response = await fetch('https://jowan13.app.n8n.cloud/webhook/follow-up', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Follow-up logged successfully!');
                    this.reset();
                    hideFollowUpForm();
                    loadDashboard(); // Refresh data
                } else {
                    alert('Error logging follow-up. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error logging follow-up. Please try again.');
            }
        });
        
        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
